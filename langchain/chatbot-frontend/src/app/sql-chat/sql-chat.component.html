<div class="app-container">
  <aside class="sidebar">
    <h3>📚 Bases de données</h3>
    
    <select [(ngModel)]="selectedDb" (change)="onDbChange()">
      <option *ngFor="let db of databases" [value]="db">{{ db }}</option>
    </select>

    <!-- Schéma affiché sous le select -->
    <div class="schema-info" *ngIf="selectedDb">
      <h4>
        <svg class="icon-schema" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#bb86fc" width="18" height="18">
          <path d="M10 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a4 4 0 0 0-4-4h-4l-2-2z"/>
        </svg>
        Schéma de la base : 
      </h4>
    </div>

    <ul class="tree">
      <li *ngFor="let table of schema | keyvalue" class="table-item">
        <div (click)="toggleTable(table.key)" class="table-name">
          <span class="icon">📂</span> {{ table.key }}
          <span class="toggle-icon">{{ expandedTables.has(table.key) ? '▼' : '▶' }}</span>
        </div>
        <ul *ngIf="expandedTables.has(table.key)" class="columns-list">
          <li *ngFor="let col of table.value" class="column-name">{{ col }}</li>
        </ul>
      </li>
    </ul>
  </aside>

  <main class="chat-area">
    <div class="chat-header">
      🧠 Chat SQL
      <button class="clear-chat-btn" (click)="clearChat()" title="Effacer la conversation">
        🗑️ Effacer le chat
      </button>
    </div>

    <div class="chat-messages" *ngIf="messages.length; else noMessages">
      <div *ngFor="let msg of messages" class="chat-message">
        <div><strong>❓ Question :</strong> {{ msg.question }}</div>

        <div class="response-split">
          <div class="response-text">
            <h4>💬 Réponse :</h4>
            <pre>{{ msg.reponse_sql }}</pre>
          </div>
          <div class="sql-text">
            <h4>🧠 Requête SQL :</h4>
            <pre>{{ msg.requete_sql }}</pre>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noMessages>
      <p>Aucune question posée pour l'instant.</p>
    </ng-template>

    <div class="chat-input">
      <input [(ngModel)]="question" placeholder="Pose ta question..." />
      <button (click)="poserQuestion()" [disabled]="loading || !selectedDb || !question.trim()">
        <ng-container *ngIf="loading; else btnText">
          <span class="spinner"></span>
        </ng-container>
        <ng-template #btnText>
          Envoyer
        </ng-template>
      </button>

    </div>
  </main>

</div>
